{"version":3,"sources":["webpack:///D:/Repo/Daily-code/UniApp/canvas海报模版-海报组件/components/lyz-canvas/lyz-canvas.vue?3a85","webpack:///D:/Repo/Daily-code/UniApp/canvas海报模版-海报组件/components/lyz-canvas/lyz-canvas.vue?e3cf","webpack:///D:/Repo/Daily-code/UniApp/canvas海报模版-海报组件/components/lyz-canvas/lyz-canvas.vue?c9ea","webpack:///D:/Repo/Daily-code/UniApp/canvas海报模版-海报组件/components/lyz-canvas/lyz-canvas.vue?b90b","uni-app:///components/lyz-canvas/lyz-canvas.vue"],"names":[],"mappings":"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A,4BAHA;AAIA,iBAJA,qBAIA;AACA;AACA,WANA;AAOA,cAPA,gBAOA,GAPA,EAOA;AACA;AACA;AACA,wBADA;;AAGA;AACA,WAbA;;AAeA,OAvBA;AAwBA,KAxHA;AAyHA;AACA,gBA1HA,wBA0HA,MA1HA,EA0HA;AACA;AACA;;AAEA,0DAFA;AAGA,4CAHA,SAGA,MAHA;;;AAMA;AACA,+BADA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,qBATA;AAUA;AACA;AACA;AACA;AACA,kCADA;;AAGA;AACA,qBAjBA,IANA;;;AA0BA,KAtJA;AAuJA,iBAvJA,yBAuJA,GAvJA,EAuJA;AACA;AACA;AACA,kBADA;AAEA;AACA;AACA;AACA;AACA;AACA,aAJA,MAIA;AACA;AACA;AACA,WAVA;AAWA;AACA;AACA,0BADA;;AAGA;AACA;;AAEA,WAlBA;;AAoBA,OArBA;AAsBA,KA9KA;AA+KA,eA/KA,uBA+KA,OA/KA,EA+KA,IA/KA,EA+KA,QA/KA,EA+KA;;AAEA;;;;;;;;;;AAUA,KA3LA;AA4LA,gBA5LA,wBA4LA,OA5LA,EA4LA,IA5LA,EA4LA;AACA;AACA;AACA;;AAEA;AACA;;;;;;AAMA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA,mEAFA,CAEA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA,0BADA;AAEA,oBAFA;AAGA,sBAHA;AAIA,oBAJA;AAKA,8BALA;AAMA,4BANA;AAOA,8BAPA;;;AAUA,KA9OA;AA+OA,YA/OA,oBA+OA,OA/OA,EA+OA,IA/OA,EA+OA;AACA;AACA,oDADA,EACA,KADA,uBACA,KADA,EACA,MADA,uBACA,MADA,EACA,KADA,uBACA,KADA,EACA,UADA,uBACA,UADA,EACA,SADA,uBACA,SADA,EACA,UADA,uBACA,UADA,EACA,QADA,uBACA,QADA;AAEA;AACA;AACA,2BAJA,GAIA,CAJA;AAKA,mBALA,GAKA,CALA,cAKA,oBALA;AAMA,+BANA,GAMA,8CANA;AAOA,uBAPA,GAOA,CAPA;AAQA,8BARA,GAQA,CARA;AASA,mBATA,GASA,CATA,cASA,iBATA;AAUA;AACA;AAXA,wBAYA,kBAZA;;;AAeA;AACA,sBAhBA,GAgBA,wCAhBA;AAiBA,8BAjBA,GAiBA,2CAjBA;AAkBA;AACA;AAnBA,8BAoBA,mHApBA;AAqBA,sCArBA;AAsBA,oEAtBA;;AAwBA,kCAxBA;;;;AA4BA;AACA;AA7BA;AA+BA,6EA/BA;;AAiCA;AACA;AAlCA,wBAmCA,oFAnCA;AAoCA,uFApCA;AAqCA,kCArCA;;;;AAyCA,4DAzCA;;AA2CA;AACA,6EA5CA;;AA8CA;AACA,mBA/CA,GA+CA,8BA/CA;AAgDA,uBAhDA;AAiDA,oCAjDA;AAkDA,0BAlDA;;;;AAsDA,yBAtDA,yBAmDA,+IACA,6BApDA;AAuDA;AACA,2CAxDA;;;AA2DA,4BA3DA;;;AA8DA;AACA,mBA/DA,GA+DA,gGA/DA;AAgEA;AACA;AACA;AACA;AACA,mBAFA,MAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,oCA1FA,QASA,GATA,kCAKA,GALA;;;AA6FA,uEA7FA;;AA+FA,KA/UA;AAgVA,YAhVA,oBAgVA,OAhVA,EAgVA,IAhVA,EAgVA;AACA;AACA;AACA;AACA;AACA;;AAEA;AANA,oBAOA,iRAPA,kCAOA,aAPA,YAOA,cAPA,YAOA,iBAPA,YAOA,gBAPA;AAQA;AACA;AACA;AACA;;;AAGA;AACA,iOAfA,CAeA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,2BADA,mDACA,CADA,qBACA,CADA,qBACA,CADA,qBACA,CADA;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,SAfA,MAeA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAHA,MAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAHA,MAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAFA,MAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,WAFA,MAEA;AACA;AACA;AACA;AACA;AACA;AACA,OA1GA;AA2GA,KA5bA,EAvDA,E","file":"components/lyz-canvas/lyz-canvas.js","sourcesContent":["import { render, staticRenderFns, recyclableRender, components } from \"./lyz-canvas.vue?vue&type=template&id=5f6464c4&\"\nvar renderjs\nimport script from \"./lyz-canvas.vue?vue&type=script&lang=js&\"\nexport * from \"./lyz-canvas.vue?vue&type=script&lang=js&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null,\n  false,\n  components,\n  renderjs\n)\n\ncomponent.options.__file = \"components/lyz-canvas/lyz-canvas.vue\"\nexport default component.exports","export * from \"-!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--16-0!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/template.js!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-uni-app-loader/page-meta.js!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./lyz-canvas.vue?vue&type=template&id=5f6464c4&\"","var components\nvar render = function() {\n  var _vm = this\n  var _h = _vm.$createElement\n  var _c = _vm._self._c || _h\n}\nvar recyclableRender = false\nvar staticRenderFns = []\nrender._withStripped = true\n\nexport { render, staticRenderFns, recyclableRender, components }","import mod from \"-!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--12-1!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./lyz-canvas.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/babel-loader/lib/index.js!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/webpack-preprocess-loader/index.js??ref--12-1!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/script.js!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/vue-cli-plugin-uni/packages/vue-loader/lib/index.js??vue-loader-options!../../../../../../HBuilderX/plugins/uniapp-cli/node_modules/@dcloudio/webpack-uni-mp-loader/lib/style.js!./lyz-canvas.vue?vue&type=script&lang=js&\"","<template>\n\t<view><canvas :canvas-id=\"id\" :style=\"'width:' + boardWidth + '; height:' + boardHeight + ';' + customStyle\"></canvas></view>\n</template>\n\n<script>\n/** 从 0x20 开始到 0x80 的字符宽度数据 */\nconst CHAR_WIDTH_SCALE_MAP = [0.296, 0.313, 0.436, 0.638, 0.586, 0.89, 0.87, 0.256, 0.334, 0.334, 0.455, 0.742, 0.241, 0.433, 0.241, 0.427, 0.586, 0.586, 0.586, 0.586, 0.586, 0.586, 0.586, 0.586, 0.586, 0.586, 0.241, 0.241, 0.742, 0.742, 0.742, 0.483, 1.031, 0.704, 0.627, 0.669, 0.762, 0.55, 0.531, 0.744, 0.773, 0.294, 0.396, 0.635, 0.513, 0.977, 0.813, 0.815, 0.612, 0.815, 0.653, 0.577, 0.573, 0.747, 0.676, 1.018, 0.645, 0.604, 0.62, 0.334, 0.416, 0.334, 0.742, 0.448, 0.295, 0.553, 0.639, 0.501, 0.64, 0.567, 0.347, 0.64, 0.616, 0.266, 0.267, 0.544, 0.266, 0.937, 0.616, 0.636, 0.639, 0.64, 0.382, 0.463, 0.373, 0.616, 0.525, 0.79, 0.507, 0.529, 0.492, 0.334, 0.269, 0.334, 0.742, 0.296];\n\nconst setStringPrototype = (screen) => {\n\t/* eslint-disable no-extend-native */\n\t  /**\n\t   * 是否支持负数\n\t   * @param {Boolean} minus 是否支持负数\n\t   * @param {Number} baseSize 当设置了 % 号时，设置的基准值\n\t   */\n\tString.prototype.toPx = function (minus, baseSize) {\n\t\tconst reg = minus ? (/^-?[0-9]+([.]{1}[0-9]+){0,1}(rpx|px|%)$/g) : (/^[0-9]+([.]{1}[0-9]+){0,1}(rpx|px|%)$/g)\n\t\tconst results = reg.exec(this);\n\t\tif (!this || !results) {\n\t\t    return 0;\n\t\t}\n\t\tconst unit = results[2];\n\t\tconst value = parseFloat(this);\n\t\tlet res = 0;\n\t\tif (unit === 'rpx') {\n\t\t      res = Math.round(value * (screen || 0.5) * 1);\n\t\t} else if (unit === 'px') {\n\t\t      res = Math.round(value * 1);\n\t\t} else if (unit === '%') {\n\t\t     res = Math.round(value * baseSize / 100);\n\t\t}\n\t\treturn res;\n\t}\n}\nexport default {\n\tprops:{\n\t\tboard: {\n\t\t\ttype: Object,\n\t\t},\n\t\tisAsync: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: true\n\t\t},\n\t\tpixelRatio: Number,\n\t\tcustomStyle: String,\n\t\tisRenderImage: Boolean\n\t},\n\tdata() {\n\t\treturn {\n\t\t\ttimer: null,\n\t\t\t// #ifdef H5 || APP-PLUS || MP-TOUTIAO\n\t\t\tid: `painter_${Math.random()}`\n\t\t\t// #endif\n\t\t\t// #ifndef H5 || APP-PLUS || MP-TOUTIAO\n\t\t\tid: `painter`\n\t\t\t// #endif\n\t\t}\n\t},\n\twatch:{\n\t\tboard: {\n\t\t\thandler: 'drawAll',\n\t\t\t// immediate: true \n\t\t\t// deep: true\n\t\t}\n\t},\n\tcomputed:{\n\t\tdpr() {\n\t\t\treturn this.pixelRatio || uni.getSystemInfoSync().pixelRatio\n\t\t},\n\t\twindowWidth() {\n\t\t\treturn uni.getSystemInfoSync().windowWidth\n\t\t},\n\t\tboardWidth() {\n\t\t\tconst {width = 200} = this.board || {}\n\t\t\treturn width \n\t\t},\n\t\tboardHeight() {\n\t\t\tconst {height = 200} = this.board || {}\n\t\t\treturn height\n\t\t}\n\t},\n\tcreated() {\n\t\tthis.init()\n\t},\n\tmounted() {\n\t\tif(this.context) {\n\t\t\tthis.drawAll()\n\t\t}\n\t},\n\tmethods: {\n\t\tasync initBoard() {\n\t\t\tconst { board } = this\n\t\t\tif(board?.views?.length) {\n\t\t\t\tlet result = await Promise.all(board.views.map(async (item) => {\n\t\t\t\t\tif(item.type === 'image') {\n\t\t\t\t\t\tconst {height, width, path} = await this.getImageInfo(item.url)\n\t\t\t\t\t\treturn Object.assign({}, item, {height, width, url: path})\n\t\t\t\t\t}\n\t\t\t\t\treturn item\n\t\t\t\t}))\n\t\t\t\treturn result || []\n\t\t\t}\n\t\t\treturn []\n\t\t},\n\t\tinit() {\n\t\t\tthis.context = uni.createCanvasContext(this.id, this)\n\t\t\tsetStringPrototype(this.windowWidth / 750)\n\t\t},\n\t\tdraw(view) {\n\t\t\tthis.context.setFillStyle(view.background || 'white')\n\t\t\tthis.context.fillRect(view.css.left.toPx(), view.css.top.toPx(), view.css.width.toPx(), view.css.height.toPx())\n\t\t\tthis.context.clip()\n\t\t\tthis.drawView(this.context, view)\n\t\t\tthis.context.draw(true, () => {\n\t\t\t\tif(this.isRenderImage) {\n\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\tthis.saveImgToLocal();\n\t\t\t\t\t}, 100)\n\t\t\t\t}\n\t\t\t})\n\t\t},\n\t\tasync drawAll() {\n\t\t\tlet views = this.isAsync ? await this.initBoard() : this.board.views\n\t\t\tif(!this.context || !views.length) {return}\n\t\t\tconst board = this.drawRect(this.context, {type: 'view',  css: {left: `${this.board?.left || 0}`, top: `${this.board?.top || 0}`, width: `${this.boardWidth}`, height: `${this.boardHeight}`, background: this.board?.background}})\n\t\t\tconst promises = views.map(item => this.drawView(this.context, item)) || [Promise.resolve()]\n\t\t\tPromise.all([board].concat(promises)).then((res) => {\n\t\t\t\tthis.context.draw(true, () => {\n\t\t\t\t\t// 防止字节大量生成\n\t\t\t\t\tif(this.isRenderImage) {\n\t\t\t\t\t\tclearTimeout(this.timer)\n\t\t\t\t\t\tthis.timer = setTimeout(() => {\n\t\t\t\t\t\t\tthis.saveImgToLocal();\n\t\t\t\t\t\t}, 100)\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t})\n\t\t},\n\t\tsaveImgToLocal() {\n\t\t\tuni.canvasToTempFilePath({\n\t\t\t\t// x: 0,\n\t\t\t\t// y: 0,\n\t\t\t\t// width:  this.boardWidth.toPx(),\n\t\t\t\t// height: this.boardWidth.toPx(),\n\t\t\t\tcanvasId: this.id,\n\t\t\t\tdestWidth: this.toNumber(this.boardWidth) * this.dpr,\n\t\t\t\tdestHeight: this.toNumber(this.boardHeight) *  this.dpr,\n\t\t\t\tsuccess: async (res) => {\n\t\t\t\t\tconst photo = await this.getImageInfo(res.tempFilePath)\n\t\t\t\t\tif(photo.path) {\n\t\t\t\t\t\tthis.$emit('success', photo.path)\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\tfail: (error) => {\n\t\t\t\t\tconsole.error(`canvasToTempFilePath failed, ${JSON.stringify(error)}`);\n\t\t\t\t\tthis.$emit('fail', {\n\t\t\t\t\t  error: error\n\t\t\t\t\t})\n\t\t\t\t}\n\t\t\t}, this)\n\t\t},\n\t\tasync drawView(context, view) {\n\t\t\tif(view.type == 'view') {\n\t\t\t\treturn this.drawRect(context, view)\n\t\t\t} else if(view.type == 'image') {\n\t\t\t\tif(this.isAsync) {\n\t\t\t\t\treturn this.drawRect(context, view)\n\t\t\t\t} else {\n\t\t\t\t\tconst {height = 0, width = 0, path: url} = await this.getImageInfo(view.url)\n\t\t\t\t\treturn this.drawRect(context, Object.assign(view, {height, width, url}))\n\t\t\t\t}\n\t\t\t} else if(view.type == 'text'){\n\t\t\t\treturn this.drawText(context, view)\n\t\t\t}\n\t\t},\n\t\ttoNumber(value, minus = 0, baseSize = 0) {\n\t\t\tif(typeof value === 'string') {\n\t\t\t\treturn value.toPx(minus, baseSize)\n\t\t\t} else if(typeof value === 'number') {\n\t\t\t\treturn value\n\t\t\t} else {\n\t\t\t\treturn 0\n\t\t\t}\n\t\t},\n\t\tbase64src(base64data) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tconst fs = uni.getFileSystemManager()\n\t\t\t\t//自定义文件名\n\t\t\t\tconst [, format, bodyData] = /data:image\\/(\\w+);base64,(.*)/.exec(base64data) || [];\n\t\t\t\t  if (!format) {reject(new Error('ERROR_BASE64SRC_PARSE'))}\n\t\t\t\tconst time = new Date().getTime();\n\t\t\t\tconst filePath = `${wx.env.USER_DATA_PATH}/${time}.${format}`\n\t\t\t\tconst buffer = uni.base64ToArrayBuffer(bodyData)\n\t\t\t\tfs.writeFile({\n\t\t\t\t    filePath,\n\t\t\t\t    data: buffer,\n\t\t\t\t    encoding: 'binary',\n\t\t\t\t    success() {\n\t\t\t\t\t\tresolve(filePath)\n\t\t\t\t    },\n\t\t\t\t    fail(err) {\n\t\t\t\t\t\treject()\n\t\t\t\t\t\tthis.$emit('fail', {\n\t\t\t\t\t\t  error: err\n\t\t\t\t\t\t})\n\t\t\t\t\t\tconsole.log('获取base64图片失败', err)\n\t\t\t\t    }\n\t\t\t\t})\n\t\t\t})\n\t\t},\n\t\t//获取图片\n\t\tgetImageInfo(imgSrc){\n\t\t\tconsole.log(imgSrc)\n\t\t\treturn new Promise(async (resolve, reject) => {\n\t\t\t\t// #ifndef H5 || APP-PLUS\n\t\t\t\tif(/^data:image\\/(\\w+);base64/.test(imgSrc)) {\n\t\t\t\t\timgSrc = await this.base64src(imgSrc)\n\t\t\t\t}\n\t\t\t\t// #endif\n\t\t\t\tuni.getImageInfo({\n\t\t\t\t\tsrc: imgSrc,\n\t\t\t\t\tsuccess: (image) => {\n\t\t\t\t\t\tconsole.log(image)\n\t\t\t\t\t\t// 微信小程序会把相对路径转为不完整的绝对路径，要在前面加'/'\n\t\t\t\t\t\t// const res = await this.downloadImage(image.path)\n\t\t\t\t\t\timage.path =  /^(http|\\/\\/|\\/|wxfile|data:image\\/(\\w+);base64|file|bdfile)/.test(image.path)  ? image.path :  `/${image.path}`\n\t\t\t\t\t\tresolve(image)\n\t\t\t\t\t\t// console.log('获取图片成功',image)\n\t\t\t\t\t},\n\t\t\t\t\tfail: (err) => {\n\t\t\t\t\t\tconsole.log(image)\n\t\t\t\t\t\treject();\n\t\t\t\t\t\tthis.$emit('fail', {\n\t\t\t\t\t\t  error: err\n\t\t\t\t\t\t})\n\t\t\t\t\t\tconsole.log('获取图片失败', err, imgSrc)\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t})\n\t\t},\n\t\tdownloadImage(url) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tconst downloadTask = uni.downloadFile({\n\t\t\t\t\turl,\n\t\t\t\t\tsuccess: (res) => {\n\t\t\t\t\t\tif(res.statusCode !== 200) {\n\t\t\t\t\t\t\tconsole.error(`downloadFile ${url} failed res.statusCode is not 200`)\n\t\t\t\t\t\t\treject();\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tresolve(res.tempFilePath)\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t\tfail: (error) => {\n\t\t\t\t\t\tuni.showToast({\n\t\t\t\t\t\t\ttitle: error\n\t\t\t\t\t\t})\n\t\t\t\t\t\tconsole.error(`downloadFile ${url} failed ${JSON.stringify(error)}`);\n\t\t\t\t\t\tresolve(url);\n\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t})\n\t\t},\n\t\tmeasureText(context, text, fontSize) {\n\t\t\t// #ifndef APP-PLUS\n\t\t\treturn context.measureText(text).width\n\t\t\t// #endif\n\t\t\t// #ifdef APP-PLUS\n\t\t\t// app measureText为0需要累加计算\n\t\t\treturn text.split(\"\").reduce((widthScaleSum, char) => {\n\t\t\t\tlet code = char.charCodeAt(0);\n\t\t\t\tlet widthScale = CHAR_WIDTH_SCALE_MAP[code - 0x20] || 1;\n\t\t\t\treturn widthScaleSum + widthScale;\n\t\t\t  }, 0) * fontSize;\n\t\t\t// #endif\n\t\t},\n\t\tcalcTextArrs(context, view) {\n\t\t\t// 拆分行\n\t\t\tconst textArray = view.text.split('\\n')\n\t\t\t// 设置属性\n\t\t\t// #ifndef MP-TOUTIAO\n\t\t\tconst fontWeight = view.css.fontWeight === 'bold' ? 'bold' : 'normal'\n\t\t\tconst textStyle = view.css.textStyle === 'italic' ? 'italic' : 'normal'\n\t\t\t// #endif\n\t\t\t// #ifdef MP-TOUTIAO\n\t\t\tconst fontWeight = view.css.fontWeight === 'bold' ? 'bold' : ''\n\t\t\tconst textStyle = view.css.textStyle === 'italic' ? 'italic' : ''\n\t\t\t// #endif\n\t\t\tconst fontSize = view.css.fontSize ?  this.toNumber(view.css.fontSize) : '20rpx'.toPx()\n\t\t\tconst fontFamily = view.css.fontFamily || 'sans-serif'\n\t\t\tcontext.font = `${textStyle} ${fontWeight} ${fontSize}px ${fontFamily}`;\n\t\t\n\t\t\tlet width = 0\n\t\t\tlet height = 0\n\t\t\tlet lines = 0\n\t\t\tconst linesArray = []\n\t\t\tfor (let index = 0; index < textArray.length; index++) {\n\t\t\t\tconst text = textArray[index]\n\t\t\t\tconst textLength = this.measureText(context, text, fontSize) // context.measureText(text).width\n\t\t\t\tconst minWidth = fontSize\n\t\t\t\tlet partWidth = view.css.width ? this.toNumber(view.css.width) : textLength\n\t\t\n\t\t\t\tif(partWidth < minWidth) {\n\t\t\t\t\tpartWidth = minWidth\n\t\t\t\t}\n\t\t\t\tconst calLines = Math.ceil(textLength / partWidth)\n\t\t\t\twidth = partWidth > width ? partWidth : width;\n\t\t\t\tlines += calLines;\n\t\t\t\tlinesArray[index] = calLines;\n\t\t\t}\n\t\t\t// 计算行数\n\t\t\tlines = view.css.maxLines < lines ? view.css.maxLines : lines\n\t\t\t// 计算行高\n\t\t\tconst lineHeight = view.css.lineHeight ? (typeof view.css.lineHeight === 'number' ? this.toNumber(view.css.lineHeight) *  fontSize : this.toNumber(view.css.lineHeight)) : fontSize * 1.2\n\t\t\theight = lineHeight * lines\n\t\t\n\t\t\treturn {\n\t\t\t\tfontSize,\n\t\t\t\twidth: width,\n\t\t\t\theight: height,\n\t\t\t\tlines: lines,\n\t\t\t\tlineHeight: lineHeight,\n\t\t\t\ttextArray: textArray,\n\t\t\t\tlinesArray: linesArray,\n\t\t\t}\n\t\t\n\t\t},\n\t\tdrawText(context, view) {\n\t\t\treturn new Promise( async (resolve, reject) => {\n\t\t\t\tconst {width, height, lines, lineHeight, textArray, linesArray, fontSize} =  this.calcTextArrs(context, view)\n\t\t\t\tcontext.fillStyle = (view.css?.color || 'black')\n\t\t\t\t// context.setTextBaseline('top')\n\t\t\t\tlet lineIndex = 0\n\t\t\t\tfor (let i = 0; i < textArray.length; i++) {\n\t\t\t\t\tconst preLineLength = Math.ceil(textArray[i].length / linesArray[i])\n\t\t\t\t\tlet start = 0\n\t\t\t\t\tlet alreadyCount = 0\n\t\t\t\t\tfor (let j = 0; j < linesArray[i]; j++) {\n\t\t\t\t\t\tcontext.save()\n\t\t\t\t\t\t// 绘制行数大于最大行数，则直接跳出循环\n\t\t\t\t\t\tif (lineIndex >= lines) {\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\talreadyCount = preLineLength\n\t\t\t\t\t\tlet text = textArray[i].substr(start, alreadyCount)\n\t\t\t\t\t\tlet measuredWith = this.measureText(context, text, fontSize)\n\t\t\t\t\t\t// 如果测量大小小于width一个字符的大小，则进行补齐，如果测量大小超出 width，则进行减除\n\t\t\t\t\t\t// 如果已经到文本末尾，也不要进行该循环\n\t\t\t\t\t\t while ((start + alreadyCount <= textArray[i].length) && (width - measuredWith > fontSize || measuredWith - width > fontSize)) {\n\t\t\t\t\t\t\tif (measuredWith < width) {\n\t\t\t\t\t\t\t\ttext = textArray[i].substr(start, ++alreadyCount);\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tif (text.length <= 1) {\n\t\t\t\t\t\t\t\t\t// 如果只有一个字符时，直接跳出循环\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\ttext = textArray[i].substr(start, --alreadyCount);\n\t\t\t\t\t\t\t\t// break;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tmeasuredWith = this.measureText(context, text, fontSize)\n\t\t\t\t\t\t}\n\t\t\t\t\t\tstart += text.length\n\t\t\t\t\t\t// 如果是最后一行了，发现还有未绘制完的内容，则加...\n\t\t\t\t\t\tif (lineIndex === lines - 1 && (i < textArray.length - 1 || start < textArray[i].length)) {\n\t\t\t\t\t\t\twhile (this.measureText(context, `${text}...`, fontSize) > width) {\n\t\t\t\t\t\t\t\tif (text.length <= 1) {\n\t\t\t\t\t\t\t\t\t// 如果只有一个字符时，直接跳出循环\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\ttext = text.substring(0, text.length - 1);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\ttext += '...';\n\t\t\t\t\t\t\tmeasuredWith = this.measureText(context, text, fontSize)\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcontext.setTextAlign(view.css.textAlign ? view.css.textAlign : 'left');\n\t\t\t\t\t\tlet x = this.toNumber(view.css.left);\n\t\t\t\t\t\tlet lineX;\n\t\t\t\t\t\tswitch (view.css.textAlign) {\n\t\t\t\t\t\t\tcase 'center':\n\t\t\t\t\t\t\t\tx = x + measuredWith / 2 +  ((this.toNumber(view.css.width) || this.toNumber(this.boardWidth, 0 , this.windowWidth)) - measuredWith) / 2;\n\t\t\t\t\t\t\t\tlineX = x - measuredWith / 2;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tcase 'right':\n\t\t\t\t\t\t\t\tx = x + (this.toNumber(view.css.width) || this.toNumber(this.boardWidth, 0 , this.windowWidth));\n\t\t\t\t\t\t\t\tlineX = x - measuredWith;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\tlineX = x;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\t// top 等于字体高度加行高\n\t\t\t\t\t\tconst y = this.toNumber(view.css.top) + (lineIndex === 0 ? fontSize : (fontSize + lineIndex * lineHeight))\n\t\t\t\t\t\t//const y = (view.css?.top?.toPx() || 0) + (this.toNumber(view.css.fontSize) + lineIndex * lineHeight) - this.toNumber(view.css.fontSize)\n\t\t\t\t\t\tlineIndex++;\n\t\t\t\t\t\tif (view.css.textStyle === 'stroke') {\n\t\t\t\t\t\t\tcontext.strokeText(text, x, y, measuredWith)\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tcontext.fillText(text, x, y, measuredWith * this.dpr)\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (view.css.textDecoration) {\n\t\t\t\t\t\t\tcontext.lineWidth = fontSize / 13;\n\t\t\t\t\t\t\tcontext.beginPath();\n\t\t\t\t\t\t\tif (/\\bunderline\\b/.test(view.css.textDecoration)) {\n\t\t\t\t\t\t\t  context.moveTo(lineX, y);\n\t\t\t\t\t\t\t  context.lineTo(lineX + measuredWith, y);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (/\\boverline\\b/.test(view.css.textDecoration)) {\n\t\t\t\t\t\t\t  context.moveTo(lineX, y - fontSize);\n\t\t\t\t\t\t\t  context.lineTo(lineX + measuredWith, y - fontSize);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (/\\bline-through\\b/.test(view.css.textDecoration)) {\n\t\t\t\t\t\t\t  context.moveTo(lineX, y - fontSize / 2.5);\n\t\t\t\t\t\t\t  context.lineTo(lineX + measuredWith, y - fontSize / 2.5);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tcontext.closePath();\n\t\t\t\t\t\t\tcontext.strokeStyle = view.css.color;\n\t\t\t\t\t\t\tcontext.stroke();\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcontext.restore()\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tsetTimeout(() => resolve('ok'), 100)\n\t\t\t})\n\t\t},\n\t\tdrawRect(context, view) {\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tlet left = view.css?.left?.toPx() || 0\n\t\t\t\tlet top = view.css?.top?.toPx() || 0\n\t\t\t\tconst width = view.css?.width.toPx() || 0\n\t\t\t\tconst height = view.css?.height.toPx() || 0\n\t\t\t\t\n\t\t\t\t// 圆角\n\t\t\t\tlet [topLeftRadius, topRightRadius, bottomRightRadius, bottomLeftRadius] = view.css?.radius?.split(' ').map((item) => /^\\d/.test(item) && item.toPx(0, width), []) || [0]\n\t\t\t\tlet radius = topLeftRadius\n\t\t\t\ttopRightRadius = topRightRadius || topLeftRadius\n\t\t\t\tbottomRightRadius = bottomRightRadius || topLeftRadius\n\t\t\t\tbottomLeftRadius = bottomLeftRadius || topRightRadius\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t// 字节不支持 transparent\n\t\t\t\tconst color = view.css?.backgroundColor || view.css?.background || 'white' //'transparent'\n\t\t\t\tconst border = view.css?.border?.split(' ').map(item => /^\\d/.test(item) ? item.toPx() : item)\n\t\t\t\tconst shadow = view.css?.shadow\n\t\t\t\tconst angle  = view.css?.rotate\n\t\t\t\t \n\t\t\t\tcontext.save()\n\t\t\t\tcontext.setFillStyle(color)\n\t\t\t\t// 旋转 \n\t\t\t\tif(angle) {\n\t\t\t\t\tcontext.translate(left + width / 2, top + height / 2)\n\t\t\t\t\tcontext.rotate(angle * Math.PI / 180)\n\t\t\t\t\tcontext.translate(- left - width / 2 , - top - height / 2)\n\t\t\t\t}\n\t\t\t\t// 投影\n\t\t\t\tif(shadow) {\n\t\t\t\t\tconst [x, y, b, c] = shadow.split(' ')\n\t\t\t\t\tcontext.shadowOffsetX = x.toPx()\n\t\t\t\t\tcontext.shadowOffsetY = y.toPx()\n\t\t\t\t\tcontext.shadowBlur = b.toPx()\n\t\t\t\t\tcontext.shadowColor = c\n\t\t\t\t}\n\t\t\t\t// 圆角\n\t\t\t\tif(radius) {\n\t\t\t\t\tcontext.beginPath()\n\t\t\t\t\t// 右下角\n\t\t\t\t\tcontext.arc(left + width - (bottomRightRadius || radius), top + height - (bottomRightRadius || radius), (bottomRightRadius || radius), 0, Math.PI * 0.5)\n\t\t\t\t\tcontext.lineTo(left + (bottomLeftRadius || radius), top + height)\n\t\t\t\t\t// 左下角\n\t\t\t\t\tcontext.arc(left + (bottomLeftRadius || radius), top + height - (bottomLeftRadius || radius), (bottomLeftRadius || radius), Math.PI * 0.5, Math.PI)\n\t\t\t\t\tcontext.lineTo(left, top + radius)\n\t\t\t\t\t// 左上角\n\t\t\t\t\tcontext.arc(left + radius, top + radius, radius, Math.PI, Math.PI * 1.5)\n\t\t\t\t\tcontext.lineTo(left + width - (topRightRadius || radius), top)\n\t\t\t\t\t// 右上角\n\t\t\t\t\tcontext.arc(left + width - (topRightRadius || radius), top + (topRightRadius || radius), (topRightRadius || radius), Math.PI * 1.5, Math.PI * 2)\n\t\t\t\t\tcontext.closePath()\n\t\t\t\t\tcontext.fill()\n\t\t\t\t} else {\n\t\t\t\t\tcontext.fillRect(left, top, width, height)\n\t\t\t\t}\n\n\t\t\t\t// 填充图片\n\t\t\t\tif(view?.type == 'image') {\n\t\t\t\t\t// 字节不支持 transparent\n\t\t\t\t\tcontext.fillStyle = 'white'\n\t\t\t\t\tradius && context.clip()\n\t\t\t\t\t// 获得缩放到图片大小级别的裁减框\n\t\t\t\t\tlet rWidth = view.width\n\t\t\t\t\tlet rHeight = view.height\n\n\t\t\t\t\tlet startX = 0\n\t\t\t\t\tlet startY = 0\n\t\t\t\t\t// 绘画区域比例\n\t\t\t\t\tconst cp = width / height\n\t\t\t\t\t// 原图比例\n\t\t\t\t\tconst op = rWidth / rHeight\n\t\t\t\t\tif (cp >= op) {\n\t\t\t\t\t\trHeight = rWidth / cp;\n\t\t\t\t\t\t// startY = Math.round((view.height - rHeight) / 2)\n\t\t\t\t\t} else {\n\t\t\t\t\t\trWidth = rHeight * cp;\n\t\t\t\t\t\tstartX = Math.round((view.width - rWidth) / 2)\n\t\t\t\t\t}\n\t\t\t\t\tif (view.css && view.mode === 'scaleToFill') {\n\t\t\t\t\t\tconsole.log(view)\n\t\t\t\t\t\tcontext.drawImage(view.url, left, top, width, height);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.log(view)\n\t\t\t\t\t\tcontext.drawImage(view.url, startX, startY, rWidth, rHeight, left, top, width, height)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// 描边\n\t\t\t\tif(border) {\n\t\t\t\t\tconst lineWidth = border[0]\n\t\t\t\t\tcontext.lineWidth = lineWidth\n\t\t\t\t\tif(border[1] == 'dashed') {\n\t\t\t\t\t\tcontext.setLineDash([Math.ceil(lineWidth * 4 / 3), Math.ceil(lineWidth * 4 / 3)])\n\t\t\t\t\t} else if(border[1] == 'dotted') {\n\t\t\t\t\t\tcontext.setLineDash([lineWidth, lineWidth])\n\t\t\t\t\t}\n\t\t\t\t\t// 字节不支持strokeStyle\n\t\t\t\t\tcontext.setStrokeStyle(border[2])\n\t\t\t\t\t// context.strokeStyle = border[2]\n\t\t\t\t\tif(radius) {\n\t\t\t\t\t\tcontext.stroke()\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcontext.strokeRect(left, top, width, height)\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tcontext.restore()\n\t\t\t\tsetTimeout(() => resolve('ok'), 50)\n\t\t\t})\n\t\t},\n\t}\n}\n</script>\n\n<style></style>"],"sourceRoot":""}