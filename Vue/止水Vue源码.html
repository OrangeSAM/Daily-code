<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Document</title>
</head>
<body>
<div id="app">
  <div>
    {{msg}}
  </div>
  <input type="text" v-model="msg">
</div>
<script>
  const utils = {
    getValue(expr, vm) {
      return vm.$data[expr]
    },
    setValue(expr, vm, newValue) {
      vm.$data[expr] = newValue
    },
    model(node, value, vm) {
      const initialValue = this.getValue(value, vm)

      node.addEventListener('input', e => {
        const newValue = e.target.value
        this.setValue(value, vm, newValue)
      })

      console.log(initialValue)
    },
    text(node, value, vm) {

    },
    on(node, value, vm, eventName) {

    }
  }
  class Compiler {
    constructor (el, vm) {
      this.el = this.isElementNode(el) ? el : document.querySelector(el)
      this.vm = vm

      const fragment = this.compileFragment(this.el)

      this.compile(fragment)
      this.el.appendChild(fragment)
    }

    compile(fragment) {
      const childNodes = Array.from(fragment.childNodes)
      childNodes.forEach(childNode => {
        if (this.isElementNode(childNode)) {
          this.compileElement(childNode)
        }
        if (this.isTextNode(childNode)) {
          this.compileText(childNode)
        }

        // DFS 深度优先遍历
        if (childNode.childNodes && childNode.childNodes.length) {
          this.compile(childNode)
        }
      })
    }

    compileText(node) {
      // {{msg}}
      const content = node.textContent
      if (/\{\{(.+)\}\}/.test(content)) {
        console.log('content', content)
      }
    }

    compileElement(node) {
      console.dir(node.attributes, 299)
      // v-model v-text v-on:click
      const attributes = Array.from(node.attributes)
      attributes.forEach(attr => {
        const {name, value} = attr
        console.log(name, value, 439)
        if (this.isDirector(name)) {
          const [, directive] = name.split('-')
          const [compileKey, eventName] = directive.split(':')
          console.log(directive, value, 22)
          utils[compileKey](node, value, this.vm, eventName)

        }
      })
    }

    isDirector(name) {
      return name.startsWith('v-')
    }

    compileFragment(el) {
      const f = document.createDocumentFragment()
      let firstChild
      while (firstChild = el.firstChild) {
        // appendChild会删掉里面的内容
        f.appendChild(firstChild)
      }
      console.dir(f)
      return f
    }

    // 是否为文本节点
    isTextNode(el) {
      return el.nodeType === 3
    }

    // 是否为元素节点
    isElementNode(el) {
      return el.nodeType === 1
    }

  }

  class Observer {
    constructor (data) {
      this.observe(data);
    }

    observe (data) {
      if (data && typeof data === "object") {
        Object.keys(data).forEach((key) => {
          console.log(key, 929, data[key])
          this.defineReactive(data, key, data[key]);
        });
      }
    }

    defineReactive (obj, key, value) {
      this.observe(value);
      Object.defineProperty(obj, key, {
        get () {
          console.log('$data get', key, value)
          return value;
        },
        set: (newVal) => {
          if (value === newVal) return;
          console.log('$data set', key, newVal)
          this.observe(newVal);
          value = newVal;
        },
      });
    }
  }

  class Vue {
    constructor (options) {
      console.log('options', options)
      this.$el = options.el;
      this.$data = options.data;
      this.$options = options.data;

      // 触发 this.$data.xx 和模板的绑定
      new Observer(this.$data);

      // 处理模板部分，将模板中使用的data部分的变量和模板绑定起来
      new Compiler(this.$el, this)

      // 将data上的数据代理到this上
      this.proxyData(this.$data);
    }

    // 可以通过this.xx 更改 this.$data.xx的结果
    proxyData (data) {
      Object.keys(data).forEach((key) => {
        Object.defineProperty(this, key, {
          get () {
            return data[key];
          },
          set (newVal) {
            data[key] = newVal;
          },
        });
      });
    }
  }
</script>
<script>
  const vm = new Vue({
    el: "#app",
    data: {
      msg: "hello aurora",
    },
  });
  vm.msg = {
    name: 'sam'
  }
  console.log(vm.msg)
</script>

</body>
</html>
